import os
import tempfile
import subprocess

from typing import Tuple
from cerebrum.tool.base import BaseTool


class CodeTestRunner(BaseTool):
    """
    Always returns: (ok: bool, err: str)
      - ok=True  => err=""
      - ok=False => err contains stderr / error message
    """
    def __init__(self):
        super().__init__()
        self.timeout: float = 1.0

    def run(self, params):
        try:
            header = params["header"]
            code = params["code"]
            tests = params["tests"]
        except Exception as e:
            return False, f"missing/invalid parameter: {repr(e)}"

        with tempfile.TemporaryDirectory(prefix="code_test_runner_") as temp_dir:
            script_path = os.path.join(temp_dir, "run_tests.py")

            script_content = (
                "# Auto-generated by CodeTestRunner\n"
                "# --- Header code ---\n"
                f"{header}\n"
                "# --- User code ---\n"
                f"{code}\n"
                "# --- Test code ---\n"
                f"{tests}\n"
            )

            #breakpoint()

            try:
                with open(script_path, "w", encoding="utf-8") as f:
                    f.write(script_content)
            except Exception as e:
                return False, f"failed to write temp script: {repr(e)}"

            try:
                completed = subprocess.run(
                    ["python", script_path],
                    stdout=subprocess.PIPE,
                    stderr=subprocess.PIPE,
                    text=True,
                    timeout=self.timeout,
                )

                if completed.returncode == 0:
                    return True, ""
                return False, (completed.stderr or "")

            except subprocess.TimeoutExpired as e:
                return False, (e.stderr or "timeout")
            except Exception as e:
                return False, f"internal exception: {repr(e)}"

            try:
                completed = subprocess.run(
                    ["python", script_path],
                    stdout=subprocess.PIPE,
                    stderr=subprocess.PIPE,
                    text=True,
                    timeout=self.timeout,
                )

                if completed.returncode == 0:
                    return True, ""
                return False, (completed.stderr or "")

            except subprocess.TimeoutExpired as e:
                return False, (e.stderr or "timeout")
            except Exception as e:
                return False, f"internal exception: {repr(e)}"

    def get_tool_call_format(self):
        tool_call_format = {
            "type": "function",
            "function": {
                "name": "code/code_test_runner",
                "description": (
                    "Execute Python code composed of three parts: "
                    "`header` (required imports and headers), `code` (the proposed solution), "
                    "and `tests` (assert-based test cases). "
                    "All three parts are combined into a single Python file and run "
                    "in an isolated subprocess. Returns (ok, stderr)."
                ),
                "parameters": {
                    "type": "object",
                    "properties": {
                        "header": {
                            "type": "string",
                            "description": (
                                "Python code that MUST appear at the top of the file. "
                                "Typically contains imports or required headers."
                            ),
                        },
                        "code": {
                            "type": "string",
                            "description": (
                                "The solution code to be tested. Must be valid Python code."
                            ),
                        },
                        "tests": {
                            "type": "string",
                            "description": (
                                "Assert-based Python tests that directly call the function. "
                                "These tests run in the same file."
                            ),
                        },
                    },
                    "required": ["header", "code", "tests"],
                },
            },
        }
        return tool_call_format